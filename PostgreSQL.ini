-- =========================================================
-- 1) Extensions (å¯é€‰)
-- =========================================================
-- ç”¨äºç”Ÿæˆ UUIDï¼ˆå¯é€‰ï¼Œä¸ç”¨ä¹Ÿè¡Œï¼‰
CREATE EXTENSION IF NOT EXISTS pgcrypto;


-- =========================================================
-- 2) News / Items
-- =========================================================
CREATE TABLE IF NOT EXISTS items (
  id              BIGSERIAL PRIMARY KEY,

  source          TEXT NOT NULL,              -- rss / hn / reddit / arxiv / web ...
  url             TEXT NOT NULL,
  canonical_url   TEXT,                       -- è§„èŒƒåŒ– URLï¼ˆå»utmç­‰ï¼‰
  title           TEXT NOT NULL,
  summary         TEXT,                       -- æŠ“å–åˆ°çš„æ‘˜è¦ï¼ˆéLLMï¼‰
  author          TEXT,
  published_at    TIMESTAMPTZ,
  fetched_at      TIMESTAMPTZ NOT NULL DEFAULT now(),

  domain          TEXT,                       -- å¯é€‰ï¼šä» url è§£æ
  hash_key        TEXT,                       -- è§„åˆ™å»é‡ keyï¼ˆä¾‹å¦‚ norm_title + domainï¼‰
  lang            TEXT,                       -- å¯é€‰ï¼šzh/en

  cluster_id      BIGINT,                     -- äº‹ä»¶èšåˆåå¡«
  raw             JSONB                       -- å¯é€‰ï¼šä¿å­˜åŸå§‹å­—æ®µï¼ˆRSSåŸå­—æ®µç­‰ï¼‰
);

-- å»é‡ï¼šcanonical_url æœ€ä¼˜
CREATE UNIQUE INDEX IF NOT EXISTS uq_items_canonical_url
  ON items (canonical_url)
  WHERE canonical_url IS NOT NULL;

-- å»é‡ï¼šhash_key æ¬¡çº§
CREATE UNIQUE INDEX IF NOT EXISTS uq_items_hash_key
  ON items (hash_key)
  WHERE hash_key IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_items_published_at ON items (published_at DESC);
CREATE INDEX IF NOT EXISTS idx_items_fetched_at   ON items (fetched_at DESC);
CREATE INDEX IF NOT EXISTS idx_items_source       ON items (source);
CREATE INDEX IF NOT EXISTS idx_items_cluster_id   ON items (cluster_id);


-- =========================================================
-- 3) News Clusters (äº‹ä»¶åŒ…)
-- =========================================================
CREATE TABLE IF NOT EXISTS clusters (
  id              BIGSERIAL PRIMARY KEY,
  kind            TEXT NOT NULL DEFAULT 'news',  -- news / other
  title           TEXT NOT NULL,                 -- èšåˆåä¸»æ ‡é¢˜
  representative_url TEXT,                       -- ä»£è¡¨é“¾æ¥
  first_seen_at   TIMESTAMPTZ NOT NULL,
  last_seen_at    TIMESTAMPTZ NOT NULL,
  item_count      INTEGER NOT NULL DEFAULT 0,

  score           DOUBLE PRECISION,              -- ranker è®¡ç®—å¾—åˆ†
  tags            TEXT[],                        -- å¯é€‰
  meta            JSONB                          -- å¯é€‰ï¼šèšåˆä¿¡æ¯
);

CREATE INDEX IF NOT EXISTS idx_clusters_last_seen_at ON clusters (last_seen_at DESC);
CREATE INDEX IF NOT EXISTS idx_clusters_score        ON clusters (score DESC);

-- å¤–é”®ï¼ˆitems.cluster_id -> clusters.idï¼‰
ALTER TABLE items
  ADD CONSTRAINT fk_items_cluster
  FOREIGN KEY (cluster_id) REFERENCES clusters(id)
  ON DELETE SET NULL
  DEFERRABLE INITIALLY DEFERRED;


-- =========================================================
-- 4) GitHub Repos
-- =========================================================
CREATE TABLE IF NOT EXISTS repos (
  id              BIGSERIAL PRIMARY KEY,

  full_name       TEXT NOT NULL,                 -- owner/name
  url             TEXT NOT NULL,
  description     TEXT,
  topics          TEXT[],                        -- topic åˆ—è¡¨
  language        TEXT,

  created_at      TIMESTAMPTZ,
  last_pushed_at  TIMESTAMPTZ,
  default_branch  TEXT,

  stars           INTEGER NOT NULL DEFAULT 0,
  forks           INTEGER NOT NULL DEFAULT 0,
  open_issues     INTEGER NOT NULL DEFAULT 0,

  fetched_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  raw             JSONB                           -- å¯é€‰ï¼šä¿å­˜ GraphQL åŸå­—æ®µ
);

CREATE UNIQUE INDEX IF NOT EXISTS uq_repos_full_name ON repos (full_name);
CREATE INDEX IF NOT EXISTS idx_repos_stars           ON repos (stars DESC);
CREATE INDEX IF NOT EXISTS idx_repos_last_pushed_at  ON repos (last_pushed_at DESC);
CREATE INDEX IF NOT EXISTS idx_repos_fetched_at      ON repos (fetched_at DESC);


-- =========================================================
-- 5) GitHub Repo Snapshots (ç”¨äºç®—æ¶¨æ˜Ÿé€Ÿåº¦)
-- =========================================================
CREATE TABLE IF NOT EXISTS repo_snapshots (
  id            BIGSERIAL PRIMARY KEY,
  repo_id       BIGINT NOT NULL REFERENCES repos(id) ON DELETE CASCADE,
  captured_at   TIMESTAMPTZ NOT NULL,        -- æŠ“å–æ—¶é—´ç‚¹ï¼ˆå»ºè®®UTCï¼‰

  stars         INTEGER NOT NULL,
  forks         INTEGER NOT NULL,
  open_issues   INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_repo_snapshots_repo_time
  ON repo_snapshots (repo_id, captured_at DESC);

CREATE INDEX IF NOT EXISTS idx_repo_snapshots_captured_at
  ON repo_snapshots (captured_at DESC);

-- å¦‚æœä½ å¸Œæœ›åŒä¸€ repo åœ¨åŒä¸€æ—¶é—´ç‚¹ä¸é‡å¤ï¼Œå¯æ‰“å¼€ä¸‹é¢å”¯ä¸€çº¦æŸï¼ˆå»ºè®®åç»­ç¡®å®šæŠ“å–ç­–ç•¥å†å¼€ï¼‰
-- CREATE UNIQUE INDEX IF NOT EXISTS uq_repo_snapshots_repo_captured
--   ON repo_snapshots (repo_id, captured_at);


-- =========================================================
-- 6) Briefs (LLM è¾“å‡ºç®€æŠ¥ï¼šæ—¥æŠ¥/å¿«è®¯/æ¦œå•è§£é‡Š)
-- =========================================================
CREATE TABLE IF NOT EXISTS briefs (
  id              BIGSERIAL PRIMARY KEY,

  kind            TEXT NOT NULL,             -- news / repo / mixed
  ref_id          BIGINT,                    -- clusters.id æˆ– repos.idï¼ˆä¸å¼ºåˆ¶å¤–é”®ï¼Œæ–¹ä¾¿æ··åˆç±»å‹ï¼‰

  score           DOUBLE PRECISION,
  title           TEXT NOT NULL,

  one_liner       TEXT,                     -- 1 å¥ç»“è®º
  why_matters     TEXT,                     -- å½±å“/ä»·å€¼
  bullets         JSONB,                    -- ["è¦ç‚¹1","è¦ç‚¹2"...]
  tags            TEXT[],                   -- åˆ†ç±»æ ‡ç­¾

  sources         JSONB,                    -- æ¥æºåˆ—è¡¨ï¼ˆURLæ•°ç»„/å¯¹è±¡æ•°ç»„ï¼‰
  url             TEXT,                     -- ä¸»é“¾æ¥ï¼ˆä¼˜å…ˆç”¨äºæ¨é€ï¼‰
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),

  sent_at         TIMESTAMPTZ               -- æ¨é€æˆåŠŸåå¡«ï¼Œé¿å…é‡å¤æ¨
);

CREATE INDEX IF NOT EXISTS idx_briefs_created_at ON briefs (created_at DESC);
CREATE INDEX IF NOT EXISTS idx_briefs_kind       ON briefs (kind);
CREATE INDEX IF NOT EXISTS idx_briefs_sent_at    ON briefs (sent_at);


-- =========================================================
-- 7) Push Log (å¯é€‰ï¼šè®°å½•æ¨é€åˆ°é£ä¹¦çš„ç»“æœï¼Œä¾¿äºæ’æŸ¥)
-- =========================================================
CREATE TABLE IF NOT EXISTS push_log (
  id              BIGSERIAL PRIMARY KEY,
  channel         TEXT NOT NULL,             -- feishu
  brief_id        BIGINT REFERENCES briefs(id) ON DELETE SET NULL,
  payload         JSONB,
  status          TEXT NOT NULL,             -- success / failed
  error_message   TEXT,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_push_log_created_at ON push_log (created_at DESC);
CREATE INDEX IF NOT EXISTS idx_push_log_status     ON push_log (status);


-- =========================================================
-- 8) (å¯é€‰) è¿è¡ŒçŠ¶æ€è¡¨ï¼šé˜²æ­¢é‡å¤è·‘/è®°å½•æ°´ä½
-- =========================================================
CREATE TABLE IF NOT EXISTS job_state (
  name            TEXT PRIMARY KEY,          -- å¦‚: collect_rss, collect_github, daily_digest
  last_run_at     TIMESTAMPTZ,
  state          JSONB
);


-- =========================================================
-- 9) è¿ç§»è¾…åŠ©ï¼ˆå®‰å…¨å¯é‡å¤æ‰§è¡Œï¼‰
-- =========================================================
ALTER TABLE briefs ADD COLUMN IF NOT EXISTS url TEXT;
UPDATE clusters SET kind = 'news' WHERE kind = 'news_cluster';


-- =========================================================
-- 10) åŒåˆ†æ”¯è§„åˆ’å¢é‡ï¼ˆå®‰å…¨å¯é‡å¤æ‰§è¡Œï¼‰
-- =========================================================

-- 10.1 raw_itemsï¼šä¿ç•™æŠ“å–è¯æ®ï¼Œæ”¯æ’‘äº‹å®æ ¸éªŒä¸æ’éšœ
CREATE TABLE IF NOT EXISTS raw_items (
  id                BIGSERIAL PRIMARY KEY,
  source_kind       TEXT NOT NULL,
  source_ref        TEXT,
  source_url        TEXT,
  retrieved_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  http_status       INTEGER,
  retrieved_headers JSONB,
  render_mode       TEXT,
  provider_chain    TEXT[],
  content_snapshot  TEXT,
  raw_payload       JSONB
);

CREATE INDEX IF NOT EXISTS idx_raw_items_retrieved_at ON raw_items (retrieved_at DESC);
CREATE INDEX IF NOT EXISTS idx_raw_items_source_kind  ON raw_items (source_kind);


-- 10.2 itemsï¼šè¡¥é½ region/safety_flags/å»é‡åŠ¨ä½œ/é‡å¤§æ›´æ–°è§£é‡Š/raw è¿½æº¯
ALTER TABLE items ADD COLUMN IF NOT EXISTS region TEXT;
ALTER TABLE items ADD COLUMN IF NOT EXISTS safety_flags TEXT[];
ALTER TABLE items ADD COLUMN IF NOT EXISTS raw_item_id BIGINT;
ALTER TABLE items ADD COLUMN IF NOT EXISTS dedup_group_id BIGINT;
ALTER TABLE items ADD COLUMN IF NOT EXISTS dedup_action TEXT;
ALTER TABLE items ADD COLUMN IF NOT EXISTS major_update_score DOUBLE PRECISION;
ALTER TABLE items ADD COLUMN IF NOT EXISTS major_update_reasons JSONB;

CREATE INDEX IF NOT EXISTS idx_items_region ON items (region);


-- 10.3 clustersï¼šè¡¥é½ä¸»é“¾æ¥ä¸è¯æ®é“¾æ¥ï¼ˆç¡®å®šæ€§é€‰æ‹© + å®¡ç¨¿/æ’éšœä¿¡æ¯ï¼‰
ALTER TABLE clusters ADD COLUMN IF NOT EXISTS primary_link TEXT;
ALTER TABLE clusters ADD COLUMN IF NOT EXISTS evidence_links JSONB;
ALTER TABLE clusters ADD COLUMN IF NOT EXISTS link_select_debug JSONB;


-- 10.4 factchecksï¼šclaims é©±åŠ¨äº‹å®æ ¸éªŒç»“æ„åŒ–è¾“å‡º
CREATE TABLE IF NOT EXISTS factchecks (
  id              BIGSERIAL PRIMARY KEY,
  topic_kind      TEXT NOT NULL,
  topic_ref_id    BIGINT,
  claims          JSONB NOT NULL,
  evidence        JSONB NOT NULL,
  confidence      DOUBLE PRECISION,
  open_questions  JSONB,
  status          TEXT NOT NULL DEFAULT 'review',
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_factchecks_created_at ON factchecks (created_at DESC);
CREATE INDEX IF NOT EXISTS idx_factchecks_status     ON factchecks (status);


-- 10.5 outputsï¼šåŒåˆ†æ”¯äº§å‡ºï¼ˆé£ä¹¦æœºå™¨äººæŠ¥å‘Š / å…¬ä¼—å·ç¨¿ï¼‰
CREATE TABLE IF NOT EXISTS outputs (
  id              BIGSERIAL PRIMARY KEY,
  branch          TEXT NOT NULL,
  topic_kind      TEXT,
  topic_ref_id    BIGINT,
  factcheck_id    BIGINT,
  content         TEXT NOT NULL,
  meta            JSONB,
  status          TEXT NOT NULL DEFAULT 'pending',
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_outputs_created_at ON outputs (created_at DESC);
CREATE INDEX IF NOT EXISTS idx_outputs_branch     ON outputs (branch);


-- 10.6 publish_logï¼šäº§å‡ºå‘å¸ƒå®¡è®¡ï¼ˆå¯ä¸ push_log å¹¶è¡Œä½¿ç”¨ï¼‰
CREATE TABLE IF NOT EXISTS publish_log (
  id              BIGSERIAL PRIMARY KEY,
  channel         TEXT NOT NULL,
  output_id       BIGINT,
  status          TEXT NOT NULL,
  error_message   TEXT,
  payload         JSONB,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_publish_log_created_at ON publish_log (created_at DESC);
CREATE INDEX IF NOT EXISTS idx_publish_log_status     ON publish_log (status);


-- 10.7 user_feedbackï¼šäººå·¥åé¦ˆé—­ç¯ï¼ˆğŸ‘/ğŸ‘/â­ï¼‰
CREATE TABLE IF NOT EXISTS user_feedback (
  id              BIGSERIAL PRIMARY KEY,
  topic_kind      TEXT,
  topic_ref_id    BIGINT,
  label           TEXT NOT NULL,
  reason          TEXT,
  user_id         TEXT,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_user_feedback_created_at ON user_feedback (created_at DESC);
CREATE INDEX IF NOT EXISTS idx_user_feedback_topic      ON user_feedback (topic_kind, topic_ref_id);


-- 10.8 job_stateï¼šè§‚æµ‹å­—æ®µï¼ˆä¸ç ´ååŸæœ‰ state JSONB ç”¨æ³•ï¼‰
ALTER TABLE job_state ADD COLUMN IF NOT EXISTS last_run_id UUID;
ALTER TABLE job_state ADD COLUMN IF NOT EXISTS items_in INTEGER;
ALTER TABLE job_state ADD COLUMN IF NOT EXISTS items_out INTEGER;
ALTER TABLE job_state ADD COLUMN IF NOT EXISTS latency_ms_by_step JSONB;
ALTER TABLE job_state ADD COLUMN IF NOT EXISTS tokens_used_by_task_type JSONB;
ALTER TABLE job_state ADD COLUMN IF NOT EXISTS cache_hit_rate DOUBLE PRECISION;

-- outputs.status å¢é‡
ALTER TABLE outputs ADD COLUMN IF NOT EXISTS status TEXT;
UPDATE outputs SET status = 'pending' WHERE status IS NULL;
CREATE INDEX IF NOT EXISTS idx_outputs_status     ON outputs (status);
